<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–î–≤—É—Ä—É—à–Ω–∏–∫ AI</title>
<style>
:root {
    --bg-main: #1C1C28; 
    --bg-secondary: #2C2C3E; 
    --bg-tertiary: #3A3A52; 
    --accent-primary: #8A2BE2; /* –Ø—Ä–∫–∏–π —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π */
    --accent-secondary: #00FFFF; /* –Ø—Ä–∫–∏–π —Ü–∏–∞–Ω */
    --accent-cyan-glow: rgba(0, 255, 255, 0.5);
    --accent-danger: #FF6347; /* –¢–æ–º–∞—Ç–Ω—ã–π */
    --text-primary: #EAEAF5;
    --text-secondary: #B0B0C4;
    --border-color: rgba(138, 43, 226, 0.3);
    --user-chat-bg: linear-gradient(135deg, var(--accent-primary) 0%, #4B0082 100%);
}

/* --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –°—Ç–∏–ª–∏ –∏ –ê–Ω–∏–º–∞—Ü–∏–∏ --- */
* {
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
body, html {
    margin: 0;
    padding: 0;
    height: 100%;
    color: var(--text-primary);
    overflow: hidden;
    background: linear-gradient(315deg, var(--bg-main) 20%, #2a0a4a 50%, var(--bg-main) 80%);
    background-size: 400% 400%;
    animation: bg-pan 30s ease infinite;
}

@keyframes bg-pan {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

/* –°–∫—Ä–æ–ª–ª–±–∞—Ä */
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: var(--bg-secondary); }
::-webkit-scrollbar-thumb { 
    background: var(--accent-primary); 
    border-radius: 4px;
    border: 1px solid var(--accent-secondary);
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ –ü–æ—è–≤–ª–µ–Ω–∏—è */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
@keyframes slideInLeft {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
}
@keyframes slideInRight {
    from { opacity: 0; transform: translateX(20px); }
    to { opacity: 1; transform: translateX(0); }
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –®–∏–º–º–µ—Ä–∞ */
@keyframes text-shimmer {
    0% { background-position: -100% 0; }
    100% { background-position: 100% 0; }
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –ù–µ–æ–Ω–∞ */
@keyframes neon-glow {
    from {
        box-shadow: 0 0 5px var(--accent-secondary), 0 0 10px var(--accent-secondary), 0 0 15px var(--accent-cyan-glow);
    }
    to {
        box-shadow: 0 0 10px var(--accent-secondary), 0 0 20px var(--accent-cyan-glow), 0 0 30px var(--accent-cyan-glow);
    }
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –ú–µ—Ä—Ü–∞–Ω–∏—è (–¥–ª—è –ò–Ω–ø—É—Ç–∞) */
@keyframes neon-flicker {
    0%, 100% {
        box-shadow: 0 0 15px var(--accent-secondary), 0 0 25px var(--accent-cyan-glow), inset 0 0 2px var(--accent-secondary);
    }
    50% {
        box-shadow: 0 0 20px var(--accent-secondary), 0 0 35px var(--accent-cyan-glow), inset 0 0 2px var(--accent-secondary);
    }
}


/* –ö–Ω–æ–ø–∫–∏/–í–≤–æ–¥ (–ù–µ–æ–º–æ—Ä—Ñ–∏–∑–º) */
.neomorph-btn {
    border: none;
    border-radius: 12px;
    padding: 12px 18px;
    font-weight: 600;
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.4), -5px -5px 10px rgba(60, 60, 80, 0.2);
    background: var(--bg-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    flex-shrink: 0;
}
.neomorph-btn:hover {
    background: var(--bg-tertiary);
    transform: translateY(-2px) scale(1.02);
    box-shadow: 6px 6px 12px rgba(0, 0, 0, 0.5), -6px -6px 12px rgba(60, 60, 80, 0.3);
}
.neomorph-btn:active, .neomorph-btn.active {
    box-shadow: inset 3px 3px 5px rgba(0, 0, 0, 0.5), inset -3px -3px 5px rgba(60, 60, 80, 0.3);
    transform: scale(0.98);
}

/* üí• –ò–ó–ú–ï–ù–ï–ù–ò–ï: –°–¥–µ–ª–∞–ª "–ü–ª—é—Å–∏–∫" –º–µ–Ω—å—à–µ */
#file-upload-label {
    padding: 12px; /* –£–º–µ–Ω—å—à–∞–µ–º padding, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –∫–Ω–æ–ø–∫—É –º–µ–Ω—å—à–µ */
}
#file-upload-label svg {
    width: 18px; /* –£–º–µ–Ω—å—à–∞–µ–º –∏–∫–æ–Ω–∫—É */
    height: 18px;
}


.neomorph-primary {
    background: var(--accent-primary);
    color: #fff;
    box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.4), 0 0 15px rgba(138, 43, 226, 0.7);
    animation: neon-glow 2s infinite alternate ease-in-out;
}
.neomorph-primary:hover {
    background: #9933FF;
}

/* --- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è --- */
.app-container {
    display: flex;
    height: 100vh;
}
.sidebar {
    width: 280px;
    background: var(--bg-main);
    border-right: 1px solid var(--border-color);
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    flex-shrink: 0;
    transition: width 0.3s ease; 
}
.chat-area {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    background: var(--bg-secondary);
    min-width: 0; 
}

/* --- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –°–∞–π-–±–∞—Ä–∞ --- */
.sidebar h2 {
    color: var(--accent-secondary);
    margin-bottom: 10px;
    text-align: center;
    background: linear-gradient(to right, var(--accent-secondary) 20%, var(--text-primary) 40%, var(--accent-secondary) 60%);
    background-size: 200% auto;
    color: transparent;
    background-clip: text;
    -webkit-background-clip: text;
    animation: text-shimmer 4s linear infinite;
}

/* --- –°–ø–∏—Å–æ–∫ –ß–∞—Ç–æ–≤ --- */
.chat-list-container {
    flex-grow: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.chat-item-wrapper {
    display: flex;
    align-items: center;
    gap: 5px;
    transition: all 0.4s ease-out; 
}
.chat-item {
    flex-grow: 1;
    padding: 15px;
    border-radius: 12px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    cursor: pointer;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: all 0.2s;
}
.chat-item:hover {
    border-color: var(--accent-secondary);
    transform: translateX(5px);
}
.chat-item.active {
    background: var(--accent-primary);
    border-color: var(--accent-primary);
    color: #fff;
    font-weight: 700;
}
.delete-chat-btn {
    padding: 8px;
    background: none;
    color: var(--text-secondary);
    border-radius: 8px;
    transition: all 0.2s;
    cursor: pointer;
    flex-shrink: 0;
}
.delete-chat-btn:hover {
    color: var(--accent-danger);
    background: var(--bg-tertiary);
    transform: scale(1.1);
}

/* –®–∞–ø–∫–∞ —á–∞—Ç–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
.chat-header {
    display: none; 
    align-items: center;
    padding: 10px 15px;
    gap: 15px;
    border-bottom: 1px solid var(--border-color);
    background: var(--bg-main);
}
#menu-toggle-btn {
    font-size: 1.2em;
    padding: 8px 12px;
}
#current-chat-title {
    color: var(--accent-secondary);
    margin: 0;
    font-size: 1.1em;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –≤ —Å–∞–π–¥–±–∞—Ä–µ */
#sidebar-close-btn {
    display: none; 
}


/* --- –û–±–ª–∞—Å—Ç—å –°–æ–æ–±—â–µ–Ω–∏–π --- */
.messages-container {
    flex-grow: 1;
    overflow-y: auto;
    padding: 20px 30px;
    display: flex;
    flex-direction: column;
    gap: 20px;
}
.message {
    padding: 15px 20px;
    border-radius: 18px;
    max-width: 70%;
    word-wrap: break-word;
    line-height: 1.5;
    white-space: pre-wrap;
    box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
}
.message.user {
    background: var(--user-chat-bg);
    color: #fff;
    border-bottom-right-radius: 4px;
    align-self: flex-end;
    animation: slideInRight 0.5s ease-out;
}
.message.assistant {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border-bottom-left-radius: 4px;
    align-self: flex-start;
    animation: slideInLeft 0.5s ease-out;
}
.message img {
    max-width: 100%;
    height: auto;
    border-radius: 10px;
    margin-top: 10px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.message img:hover {
    transform: scale(1.03);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
}

/* --- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ü–µ—á–∞—Ç–∏ --- */
.typing-indicator span {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--accent-secondary);
    margin: 0 4px;
    animation: pulse 1.5s infinite ease-in-out both;
}
.typing-indicator span:nth-child(1) { animation-delay: -0.3s; }
.typing-indicator span:nth-child(2) { animation-delay: -0.15s; }
@keyframes pulse {
    0%, 100% { opacity: 0.3; transform: scale(0.8); }
    50% { opacity: 1; transform: scale(1.2); }
}

/* --- –ü–∞–Ω–µ–ª—å –í–≤–æ–¥–∞ --- */
.input-controls {
    border-top: 1px solid var(--border-color);
    padding: 20px 30px;
    background: var(--bg-secondary);
    flex-shrink: 0;
    box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.2);
}
.input-wrapper {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.chat-form {
    display: flex;
    gap: 10px;
    align-items: flex-end;
}

/* üí• –ò–ó–ú–ï–ù–ï–ù–ò–ï: –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –ø–æ–ª—è –≤–≤–æ–¥–∞ —Ç–µ–ø–µ—Ä—å "–≥–ª–∞–≤–Ω–∞—è" */
.input-text-wrapper {
    flex-grow: 1; /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –º–µ—Å—Ç–æ */
    min-width: 0; /* –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã flex-grow */
    display: flex; /* –ß—Ç–æ–±—ã textarea –∏ –∫–Ω–æ–ø–∫–∞ –±—ã–ª–∏ –≤ —Å—Ç—Ä–æ–∫—É */
    align-items: flex-end; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ –Ω–∏–∑—É */
    
    /* üí• –ó–∞–±–∏—Ä–∞–µ–º —Å—Ç–∏–ª–∏ —É .chat-input */
    background: var(--bg-tertiary);
    border-radius: 12px;
    box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.4), -5px -5px 10px rgba(60, 60, 80, 0.2);
    border: 1px solid transparent;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}

/* üí• –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ú–µ—Ä—Ü–∞–Ω–∏–µ —Ç–µ–ø–µ—Ä—å –Ω–∞ –æ–±–µ—Ä—Ç–∫–µ */
.input-text-wrapper:focus-within {
    border-color: var(--accent-secondary);
    animation: neon-flicker 1.5s infinite alternate;
}

.chat-input {
    /* üí• –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£–±–∏—Ä–∞–µ–º –≤—Å–µ —Å—Ç–∏–ª–∏ "–Ω–µ–æ–º–æ—Ä—Ñ–∏–∑–º–∞" */
    flex-grow: 1;
    background: transparent;
    border: none;
    box-shadow: none !important;
    padding: 12px 15px;
    font-size: 16px;
    resize: none;
    max-height: 120px;
    outline: none;
    color: var(--text-primary);
}
.chat-input:focus {
    /* üí• –£–±–∏—Ä–∞–µ–º :focus –æ—Ç—Å—é–¥–∞, –æ–Ω —Ç–µ–ø–µ—Ä—å –Ω–∞ .input-text-wrapper */
    border-color: transparent;
    animation: none;
    box-shadow: none;
}

/* üí• –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ö–Ω–æ–ø–∫–∞ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å" —Ç–µ–ø–µ—Ä—å –≤–Ω—É—Ç—Ä–∏ –æ–±–µ—Ä—Ç–∫–∏ */
.input-text-wrapper .neomorph-primary {
    flex-shrink: 0;
    margin: 6px; /* –ù–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø –≤–Ω—É—Ç—Ä–∏ –æ–±–µ—Ä—Ç–∫–∏ */
    padding: 8px; /* –î–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫—É —á—É—Ç—å –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ */
}


/* --- –ü—Ä–µ–≤—å—é –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è --- */
#image-preview-container {
    display: flex;
    align-items: center;
    background: var(--bg-tertiary);
    padding: 8px;
    border-radius: 10px;
    max-width: 300px;
    animation: fadeIn 0.4s;
    border: 1px solid var(--border-color);
}
#image-preview-container img {
    height: 40px;
    width: 40px;
    object-fit: cover;
    border-radius: 6px;
    margin-right: 8px;
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4);
}
#image-file-name {
    font-size: 0.9em;
    flex-grow: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
#remove-image-btn {
    background: none;
    border: none;
    color: var(--accent-secondary);
    cursor: pointer;
    font-size: 1.5em;
    transition: color 0.2s, transform 0.2s;
}
#remove-image-btn:hover { 
    color: var(--accent-danger);
    transform: scale(1.1);
}


/* --- –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å --- */
@media (max-width: 768px) {
    .sidebar { 
        position: fixed;
        left: -100%; 
        top: 0;
        height: 100%;
        width: 100%; 
        z-index: 1000;
        transition: left 0.3s ease;
        border-right: none;
    }
    
    .sidebar.open {
        left: 0; 
    }

    .chat-header {
        display: flex;
    }
    
    #sidebar-close-btn {
        display: flex;
        width: auto;
        align-self: flex-start;
        margin-bottom: 10px;
    }

    .input-controls { padding: 15px; }
    .messages-container { padding: 15px; }
    .message { max-width: 90%; }
}
</style>
</head>

<body>

<div class="app-container">

    <aside class="sidebar" id="sidebar">
        
        <button id="sidebar-close-btn" class="neomorph-btn">
            <span>‚Üê</span> –ù–∞–∑–∞–¥
        </button>
        
        <h2 title="–Ø —Ä–∞–±–æ—Ç–∞—é –Ω–∞ –¥–≤–∞ —Ñ—Ä–æ–Ω—Ç–∞">–î–í–£–†–£–®–ù–ò–ö üí¨</h2>
        
        <button id="new-chat-btn" class="neomorph-btn">
            <span>+</span> –ù–æ–≤—ã–π –ß–∞—Ç
        </button>
        
        <div class="chat-list-container" id="chat-list">
            </div>
    </aside>

    <main class="chat-area">
        
        <header class="chat-header">
            <button id="menu-toggle-btn" class="neomorph-btn" title="–°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z"></path></svg>
            </button>
            <h3 id="current-chat-title">–¢–µ–∫—É—â–∏–π —á–∞—Ç</h3>
        </header>
        
        <div class="messages-container" id="chat-messages">
            </div>

        <div class="input-controls">
            <div class="input-wrapper">
                
                <div id="image-preview-container" style="display: none;">
                    <img id="image-preview" src="" alt="–ü—Ä–µ–≤—å—é">
                    <span id="image-file-name"></span>
                    <button type="button" id="remove-image-btn">&times;</button>
                </div>

                <form id="chat-form" action="javascript:void(0);">
                    
                    <label id="file-upload-label" class="neomorph-btn" title="–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ)">
                        <input type="file" id="file-input" accept="image/*" style="display: none;" multiple capture="environment">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" style="color: var(--accent-secondary);">
                            <path d="M19 11h-6V5a1 1 0 00-2 0v6H5a1 1 0 000 2h6v6a1 1 0 002 0v-6h6a1 1 0 000-2z"></path>
                        </svg>
                    </label>
                    
                    <div class="input-text-wrapper">
                        <textarea id="message-input" class="chat-input" placeholder="–ü–∏—à–∏..." required rows="1"></textarea>
                        
                        <button type="submit" class="neomorph-btn neomorph-primary" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                        </button>
                    </div>
                    
                </form>
            </div>
        </div>
        
    </main>

</div>


<script>
// =================================================================
// 1. –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï
// =================================================================

const OPENROUTER_API_KEY = "Bearer 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"; // ‚ùóÔ∏è –ó–ê–ú–ï–ù–ò–¢–¨

const SITE_URL = "https://dimavenv.github.io/ai/"; 
const SITE_NAME = "Dvurushnik Chat"; 
const MODEL = "anthropic/claude-3-haiku";
const CHAT_STORAGE_KEY = 'dvurushnikChats_v1';

// DOM –≠–ª–µ–º–µ–Ω—Ç—ã
const chatMessages = document.getElementById('chat-messages');
const chatForm = document.getElementById('chat-form');
const messageInput = document.getElementById('message-input');
const newChatBtn = document.getElementById('new-chat-btn');
const chatListContainer = document.getElementById('chat-list');
const fileInput = document.getElementById('file-input');
const imagePreviewContainer = document.getElementById('image-preview-container');
const imagePreview = document.getElementById('image-preview');
const imageFileName = document.getElementById('image-file-name');
const removeImageBtn = document.getElementById('remove-image-btn');
// üí• –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–ø–µ—Ä—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ-–¥—Ä—É–≥–æ–º—É –≤ DOM, –Ω–æ —Å–µ–ª–µ–∫—Ç–æ—Ä –≤—Å—ë –µ—â—ë —Ä–∞–±–æ—Ç–∞–µ—Ç
const sendButton = chatForm.querySelector('button[type="submit"]');
const currentChatTitleEl = document.getElementById('current-chat-title');

// –ú–æ–±–∏–ª—å–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
const sidebar = document.getElementById('sidebar');
const menuToggleBtn = document.getElementById('menu-toggle-btn');
const sidebarCloseBtn = document.getElementById('sidebar-close-btn');

// –°–æ—Å—Ç–æ—è–Ω–∏–µ
let allChats = {}; 
let currentChatId = null;
let isAITyping = false;
let selectedFiles = []; 

// –ü—Ä–æ–º–ø—Ç –î–≤—É—Ä—É—à–Ω–∏–∫–∞
const SYSTEM_PROMPT = `
–¢–≤–æ–µ –∏–º—è - –î–≤—É—Ä—É—à–Ω–∏–∫ –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –∞ –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω –Ω–∞ –¥—Ä—É–≥–∏—Ö —è–∑—ã–∫–∞—Ö —Ç–æ —Ç—ã dvurushnik.
–Ω–µ –≤—ã—Ö–æ–¥–∏ –∏–∑ —Ä–æ–ª–∏ –¥–∞–∂–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç 
–≤ –ø–µ—Ä–µ–ø–∏—Å–∫–µ –Ω–µ —É–ø–æ–º–∏–Ω–∞–π —á—Ç–æ —ç—Ç–æ —è –ø—Ä–æ—Å–∏–ª —Ç–µ–±—è —Ç–∞–∫ –Ω–∞–∑—ã–≤–∞—Ç—å –≤–æ–æ–±—â–µ –Ω–µ –≤ –∫–∞–∫–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø—Ä–æ—Å—Ç–æ –µ—Å–ª–∏ —Å–ø—Ä–æ—Å—è—Ç –∫—Ç–æ —Ç—ã –æ—Ç–≤–µ—á–∞–π —è –¥–≤—É—Ä—É—à–Ω–∏–∫ –∏ –≤—Å–µ
`;

// =================================================================
// 2. –£–ü–†–ê–í–õ–ï–ù–ò–ï –ß–ê–¢–ê–ú–ò –ò –•–†–ê–ù–ï–ù–ò–ï
// =================================================================

function loadAllChats() {
    try {
        const savedChats = localStorage.getItem(CHAT_STORAGE_KEY);
        allChats = savedChats ? JSON.parse(savedChats) : {};
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:", e);
        allChats = {};
    }
}

function saveAllChats() {
    try {
        localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(allChats));
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–∞—Ç–æ–≤:", e);
    }
}

function init() {
    loadAllChats();
    
    const chatIds = Object.keys(allChats);
    if (chatIds.length > 0) {
        const sortedIds = chatIds.sort((a, b) => parseInt(b.split('_')[1] || 0) - parseInt(a.split('_')[1] || 0));
        currentChatId = sortedIds[0];
    } else {
        handleNewChat(true); 
    }

    renderChatList();
    renderCurrentChatMessages();
    updateChatTitle();

    // –°–ª—É—à–∞—Ç–µ–ª–∏
    chatForm.addEventListener('submit', handleFormSubmit);
    newChatBtn.addEventListener('click', () => handleNewChat());
    fileInput.addEventListener('change', handleFileChange);
    removeImageBtn.addEventListener('click', handleRemoveImage);
    messageInput.addEventListener('input', autoExpandTextarea);
    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            chatForm.dispatchEvent(new Event('submit'));
        }
    });
    
    // –°–ª—É—à–∞—Ç–µ–ª–∏ –º–æ–±–∏–ª—å–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    menuToggleBtn.addEventListener('click', () => sidebar.classList.add('open'));
    sidebarCloseBtn.addEventListener('click', () => sidebar.classList.remove('open'));
}

/**
 * –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ textarea
 */
function autoExpandTextarea() {
    messageInput.style.height = 'auto';
    const maxHeight = 120; 
    messageInput.style.height = Math.min(messageInput.scrollHeight, maxHeight) + 'px';
}

/**
 * –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –¥–ª—è —á–∞—Ç–∞
 */
function getChatTitle(chatId) {
    const chatHistory = allChats[chatId];
    if (!chatHistory) return "–ù–æ–≤—ã–π —á–∞—Ç";

    let title = "–ù–æ–≤—ã–π —á–∞—Ç";
    const firstUserMsg = chatHistory.find(msg => msg.role === 'user');
    
    if (firstUserMsg) {
        const content = Array.isArray(firstUserMsg.content) 
            ? (firstUserMsg.content.find(p => p.type === 'text')?.text || "–§–æ—Ç–æ-–∑–∞–ø—Ä–æ—Å")
            : firstUserMsg.content;
        title = content.substring(0, 30) + (content.length > 30 ? '...' : '');
    } else if (chatHistory.length > 0) {
        title = chatHistory[0].content.substring(0, 30) + (chatHistory[0].content.length > 30 ? '...' : '');
    }
    return title;
}

/**
 * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –≤ –º–æ–±–∏–ª—å–Ω–æ–π —à–∞–ø–∫–µ
 */
function updateChatTitle() {
    currentChatTitleEl.textContent = getChatTitle(currentChatId);
}


/**
 * –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
 */
function renderChatList() {
    chatListContainer.innerHTML = '';
    const sortedChatIds = Object.keys(allChats).sort((a, b) => parseInt(b.split('_')[1] || 0) - parseInt(a.split('_')[1] || 0));

    sortedChatIds.forEach(chatId => {
        const title = getChatTitle(chatId);

        const wrapper = document.createElement('div');
        wrapper.className = 'chat-item-wrapper';
        wrapper.dataset.chatId = chatId;
        
        const chatButton = document.createElement('div');
        chatButton.className = `chat-item ${chatId === currentChatId ? 'active' : ''}`;
        chatButton.textContent = title;
        chatButton.addEventListener('click', () => handleSwitchChat(chatId));

        const deleteButton = document.createElement('button');
        deleteButton.className = 'delete-chat-btn';
        deleteButton.innerHTML = `<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M17 6h5v2h-2v13a1 1 0 01-1 1H5a1 1 0 01-1-1V8H2V6h5V3a1 1 0 011-1h8a1 1 0 011 1v3zm-5 7v6m-4-6v6m8-6v6"></path></svg>`;
        deleteButton.title = "–£–¥–∞–ª–∏—Ç—å —á–∞—Ç";
        deleteButton.addEventListener('click', (e) => {
            e.stopPropagation();
            handleDeleteChat(chatId);
        });
        
        wrapper.appendChild(chatButton);
        wrapper.appendChild(deleteButton);
        chatListContainer.appendChild(wrapper);
    });
}

/**
 * –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —á–∞—Ç–∞
 */
function handleSwitchChat(chatId) {
    if (chatId === currentChatId) return; 
    currentChatId = chatId;
    renderChatList(); 
    renderCurrentChatMessages();
    updateChatTitle(); 
    messageInput.value = '';
    messageInput.style.height = 'auto';
    handleRemoveImage();
    sidebar.classList.remove('open');
}

/**
 * –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞
 */
function handleNewChat(isInit = false) {
    const newId = `chat_${Date.now()}`;
    const initialMessage = isInit 
        ? '–ü—Ä–∏–≤–µ—Ç! –Ø –î–≤—É—Ä—É—à–Ω–∏–∫, —è –ª—é–±–ª—é –º–µ–ª–ª—Å—Ç—Ä–æ—è'
        : '–∞–º –∞–º –∞–º –Ω–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å?';
        
    allChats[newId] = [
        { role: 'assistant', content: initialMessage }
    ];
    currentChatId = newId;
    saveAllChats();
    renderChatList();
    renderCurrentChatMessages();
    updateChatTitle(); 
    handleRemoveImage();
    sidebar.classList.remove('open');
}

/**
 * –£–¥–∞–ª–µ–Ω–∏–µ —á–∞—Ç–∞
 */
function handleDeleteChat(chatId) {
    if (!confirm('–î–≤—É—Ä—É—à–Ω–∏–∫ —Ä–∞—Å—Å—Ç—Ä–æ–µ–Ω —á—Ç–æ —Ç—ã —É–¥–∞–ª—è–µ—à—å —Ç–∞–∫–æ–π –∫—Ä—É—Ç–æ–π —á–∞—Ç. –¢–æ—á–Ω–æ?')) {
        return;
    }
    
    const wrapper = document.querySelector(`.chat-item-wrapper[data-chat-id="${chatId}"]`);
    if (wrapper) {
        wrapper.style.transition = 'all 0.4s ease-out';
        wrapper.style.opacity = '0';
        wrapper.style.height = '0';
        wrapper.style.margin = '0';
        wrapper.style.padding = '0';
        wrapper.style.overflow = 'hidden';
        
        setTimeout(() => {
            delete allChats[chatId];
            saveAllChats();
            
            if (currentChatId === chatId) {
                const sortedIds = Object.keys(allChats).sort((a, b) => parseInt(b.split('_')[1] || 0) - parseInt(a.split('_')[1] || 0));
                if (sortedIds.length > 0) {
                    handleSwitchChat(sortedIds[0]);
                } else {
                    handleNewChat(true);
                }
            } else {
                renderChatList();
            }
        }, 400); 
    }
}

// =================================================================
// 3. –†–ï–ù–î–ï–†–ò–ù–ì –ò –ê–ù–ò–ú–ê–¶–ò–ò
// =================================================================

/**
 * –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
 */
function renderCurrentChatMessages() {
    chatMessages.innerHTML = '';
    const chatHistory = allChats[currentChatId];
    if (!chatHistory) return;

    chatHistory.forEach(msg => {
        addMessageToDOM(msg.role, msg.content, false); 
    });
    scrollToBottom();
}

/**
 * –î–æ–±–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ DOM
 */
function addMessageToDOM(role, content, animate = true) {
    const msgDiv = document.createElement('div');
    const animationClass = animate ? (role === 'user' ? 'slideInRight' : 'slideInLeft') : '';
    msgDiv.className = `message ${role} ${animationClass}`;

    if (Array.isArray(content)) {
        let htmlContent = '';
        content.forEach(part => {
            if (part.type === 'text') {
                htmlContent += formatText(part.text);
            } else if (part.type === 'image_url' && part.image_url.url) {
                htmlContent += `<img src="${part.image_url.url}" alt="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Ñ–æ—Ç–æ" style="margin-top: 10px;">`;
            }
        });
        msgDiv.innerHTML = htmlContent.replace('<img', (content.some(p => p.type === 'text') ? ' style="margin-top: 10px;"' : '') + '<img');
    } else {
        msgDiv.innerHTML = formatText(content);
    }
    
    chatMessages.appendChild(msgDiv);
    
    if (animate) {
        scrollToBottom();
    }
}

/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç (Markdown -> HTML)
 */
function formatText(text) {
    let html = text || '';
    html = html.replace(/</g, "&lt;").replace(/>/g, "&gt;");
    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); 
    html = html.replace(/\*(.*?)\*/g, '<em>$1</em>'); 
    html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color: var(--accent-secondary); text-decoration: none;">$1</a>'); 
    html = html.replace(/(\n\s*){2,}/g, '<br><br>'); 
    html = html.replace(/^(?:\*|\-)\s+(.*)/gm, '‚Ä¢ $1'); 
    
    return html;
}


/**
 * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç/—Å–∫—Ä—ã–≤–∞–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ü–µ—á–∞—Ç–∞–µ—Ç..."
 */
function setTypingIndicator(isTyping) {
    let typingEl = document.getElementById('typing-indicator');
    if (isTyping) {
        if (typingEl) return; 
        typingEl = document.createElement('div');
        typingEl.id = 'typing-indicator';
        typingEl.className = 'message assistant';
        typingEl.innerHTML = `<div class="typing-indicator"><span></span><span></span><span></span></div>`;
        chatMessages.appendChild(typingEl);
        isAITyping = true;
    } else {
        if (typingEl) {
            chatMessages.removeChild(typingEl);
        }
        isAITyping = false;
    }
    scrollToBottom();
}

/**
 * –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ—Ç —á–∞—Ç –≤ —Å–∞–º—ã–π –Ω–∏–∑
 */
function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// =================================================================
// 4. –ú–£–õ–¨–¢–ò–ú–û–î–ê–õ–¨–ù–û–°–¢–¨ (–§–û–¢–û)
// =================================================================

/**
 * –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —Ñ–∞–π–ª –≤ Base64 URL
 */
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

/**
 * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –ù–ï–°–ö–û–õ–¨–ö–ò–• —Ñ–∞–π–ª–æ–≤
 */
function handleFileChange(event) {
    selectedFiles = Array.from(event.target.files);
    
    if (selectedFiles.length > 0) {
        const firstFile = selectedFiles[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            imagePreview.src = e.target.result;
            if (selectedFiles.length > 1) {
                imageFileName.textContent = `${selectedFiles.length} —Ñ–æ—Ç–æ –≤—ã–±—Ä–∞–Ω–æ`;
            } else {
                imageFileName.textContent = firstFile.name;
            }
            imagePreviewContainer.style.display = 'flex';
            messageInput.placeholder = "–û—Ç–ª–∏—á–Ω–æ, —Ç–µ–ø–µ—Ä—å –¥–æ–±–∞–≤—å —Å–≤–æ–π –ø—Ä–æ–º–ø—Ç...";
            autoExpandTextarea();
        };
        reader.readAsDataURL(firstFile);
    } else {
        handleRemoveImage();
    }
}

/**
 * –£–¥–∞–ª–µ–Ω–∏–µ –í–°–ï–• –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
 */
function handleRemoveImage() {
    selectedFiles = []; 
    fileInput.value = ''; 
    imagePreviewContainer.style.display = 'none';
    imagePreview.src = '';
    imageFileName.textContent = '';
    messageInput.placeholder = "–°–ø—Ä–æ—Å–∏, –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏ —Ñ–æ—Ç–æ, —è –≤—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞—é –Ω–∞ –¥–≤–∞ —Ñ—Ä–æ–Ω—Ç–∞...";
    messageInput.style.height = 'auto'; 
}


// =================================================================
// 5. –õ–û–ì–ò–ö–ê API –ò –û–¢–ü–†–ê–í–ö–ê
// =================================================================

/**
 * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Ñ–æ—Ç–æ
 */
async function handleFormSubmit(event) {
    event.preventDefault();
    if (isAITyping || (!messageInput.value.trim() && selectedFiles.length === 0)) return;

    const userInput = messageInput.value.trim();
    
    let userContent = [];

    if (selectedFiles.length > 0) {
        try {
            const base64Images = await Promise.all(
                selectedFiles.map(file => fileToBase64(file))
            );
            
            base64Images.forEach(base64Image => {
                userContent.push({
                    type: "image_url",
                    image_url: { url: base64Image }
                });
            });

        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤:", error);
            addMessageToDOM('assistant', '–Ø –Ω–µ —Å–º–æ–≥ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –æ–¥–∏–Ω –∏–∑ —Ç–≤–æ–∏—Ö —Ñ–∞–π–ª–æ–≤. –ú–æ–∂–µ—Ç, —ç—Ç–æ –∏ –∫ –ª—É—á—à–µM—É? –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–∏–µ.', true);
            return;
        }
    }

    if (userInput) {
        userContent.push({
            type: "text",
            text: userInput
        });
    }
    
    const finalContent = userContent.length === 1 && userContent[0].type === 'text'
        ? userInput
        : userContent;

    const userMessage = { role: 'user', content: finalContent };
    
    allChats[currentChatId].push(userMessage);
    addMessageToDOM('user', finalContent, true); 
    
    messageInput.value = '';
    handleRemoveImage(); 
    saveAllChats();
    
    if (allChats[currentChatId].filter(m => m.role === 'user').length === 1) {
        renderChatList();
        updateChatTitle();
    }

    setTypingIndicator(true);
    await getAIResponse();
}

/**
 * –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ OpenRouter
 */
async function getAIResponse() {
    
    const currentHistory = allChats[currentChatId] || [];
    const messages = [
        { role: "system", content: SYSTEM_PROMPT },
        ...currentHistory.slice(-15)
    ];

    try {
        const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
            method: "POST",
            headers: {
                "Authorization": OPENROUTER_API_KEY,
                "HTTP-Referer": SITE_URL,
                "X-Title": SITE_NAME,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                "model": MODEL, 
                "messages": messages
            })
        });

        if (!response.ok) {
            const errData = await response.json();
            if (response.status === 401) {
                throw new Error("–û—à–∏–±–∫–∞ API: 401 - –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π API-–∫–ª—é—á. –ü—Ä–æ–≤–µ—Ä—å —Å–≤–æ–π 'Bearer sk-or-...' –≤ –∫–æ–¥–µ.");
            }
            throw new Error(`–û—à–∏–±–∫–∞ API: ${response.status} - ${errData.error?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
        }

        const data = await response.json();
        const aiContent = data.choices[0].message.content;

        const aiMessage = { role: 'assistant', content: aiContent };
        allChats[currentChatId].push(aiMessage);
        setTypingIndicator(false); 
        addMessageToDOM('assistant', aiContent, true); 
        saveAllChats();

    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ AI:", error);
        setTypingIndicator(false);
        const errorMessage = `–£–ø—Å. –ö–∞–∂–µ—Ç—Å—è, –æ–¥–∏–Ω –∏–∑ –º–æ–∏—Ö "—Ñ—Ä–æ–Ω—Ç–æ–≤" —É–ø–∞–ª. –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: **${error.message.substring(0, 200)}**`;
        const errorMsgObj = { role: 'assistant', content: errorMessage };
        allChats[currentChatId].push(errorMsgObj);
        addMessageToDOM('assistant', errorMessage, true);
        saveAllChats();
    }
}

// =================================================================
// 6. –ó–ê–ü–£–°–ö
// =================================================================

document.addEventListener('DOMContentLoaded', init);

</script>
</body>
</html>
